# -*- coding: utf-8 -*-
import re
import os
import pickle
from os import listdir
from os.path import isfile, join

def getOPCode(files, dalvik_opcodes):
    OPList = ''
    for file in files:
        reader = file.read()
        for i, part in enumerate(reader.split(".method")):
            if i != 0:
                method_part=part.split(".end method")[0]
                method_body = method_part.strip().split('\n')
                for line in method_body:
                    if not line.strip().startswith('.') and not line.strip().startswith('#') and line.strip():
                        method_line = line.strip().split()
                        if method_line[0] in dalvik_opcodes:
                            OPList += (dalvik_opcodes[method_line[0]] + ' ')
    return OPList

BenginPath = "Android_Sample\\Benign"
MalwarePath = "Android_Sample\\Malware"

list_bengin_dirs = [BenginPath + os.path.sep + dir for dir in listdir(BenginPath) if os.path.isdir(join(BenginPath, dir))]
list_malware_dirs = [MalwarePath + os.path.sep + dir for dir in listdir(MalwarePath) if os.path.isdir(join(MalwarePath, dir))]

Bengin_OPCode = []
Malware_OPCode = []
dalvik_opcodes = {}
limit = len(list_bengin_dirs)
# limit = 500

with open("TranslateOpcodes_Android.txt") as fop:
    for linee in fop:
        (key, val) = linee.split()
        dalvik_opcodes[key] = val
# print(dalvik_opcodes)

for i, bengin_dir in enumerate(list_bengin_dirs):

    smali_dir = os.path.join(bengin_dir, "smali")
    smali_files = []
    print('bengin:', bengin_dir, 'num = ', i + 1, '/',  len(list_bengin_dirs))
    for root, dirs, files in os.walk(smali_dir, topdown=False):
        for name in files:
            smali_files.append(open(os.path.join(smali_dir, os.path.join(root, name)), 'r', encoding='utf-8', errors='ignore'))
    Bengin_OPCode.append(getOPCode(smali_files, dalvik_opcodes))
    # print(Bengin_OPCode[i])

    for file in smali_files:
        file.close()
    if i == limit-1:
        break

for i, malware_dir in enumerate(list_malware_dirs):

    smali_dir = os.path.join(malware_dir, "smali")
    smali_files = []
    print('malware:', malware_dir, 'num = ', i + 1, '/',  len(list_malware_dirs))
    for root, dirs, files in os.walk(smali_dir, topdown=False):
        for name in files:
            smali_files.append(open(os.path.join(smali_dir, os.path.join(root, name)), 'r', encoding='utf-8', errors='ignore'))
    Malware_OPCode.append(getOPCode(smali_files, dalvik_opcodes))
    # print(Malware_OPCode[i])

    for file in smali_files:
        file.close()
    if i == limit-1:
        break

outfile1 = open('BMsave\Bengin_Android_OPCodeList', 'w+b')
pickle.dump(Bengin_OPCode, outfile1)
outfile1.close()

outfile1 = open('BMsave\Malware_Android_OPCodeList', 'w+b')
pickle.dump(Malware_OPCode, outfile1)
outfile1.close()
